<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="ドリンクメニュー一覧" />
  <title>Drinks Menu | WACK DA. VINCI</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600&family=Noto+Sans+JP:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css" />

  <style>
    .page{
      width: min(var(--max), calc(100% - 2.2rem));
      margin: 0 auto;
      padding: 6.8rem 0 3.2rem;
    }
    .page-head{ display:grid; gap:.25rem; margin-bottom: 1.2rem; }
    .page-title{
      margin:0;
      font-family:"Cinzel", serif;
      letter-spacing:.06em;
      font-size: clamp(1.6rem, 4.8vw, 2.2rem);
    }
    .page-sub{ margin:0; color: var(--muted); font-size:.95rem; }

    .toolbar{
      display:flex; gap:.75rem; flex-wrap: wrap;
      align-items:center; justify-content: flex-start;
      margin: 1.1rem 0 1.4rem;
    }
    .chipbar{ display:flex; gap:.5rem; flex-wrap: wrap; }
    .chip{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      border-radius: 999px;
      padding: .5rem .75rem;
      font-size: .88rem;
      cursor: pointer;
      user-select: none;
    }
    .chip[aria-pressed="true"]{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.22);
      color: rgba(255,255,255,.95);
    }

    .menu{ display:grid; gap: 1.4rem; }
    .genre{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .genre-head{
      padding: 1.05rem 1.1rem;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.20);
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
    }
    .genre-head h2{ margin:0; font-size: 1.1rem; letter-spacing:.04em; }
    .genre-head span{ color: rgba(255,255,255,.55); font-size: .85rem; white-space: nowrap; }

    /* 写真あり（上） */
    .menu-grid{
      display:grid;
      gap: .9rem;
      padding: 1rem;
      grid-template-columns: 1fr;
    }
    .menu-card{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 1rem;
      overflow:hidden;
      display:grid;
    }
    .menu-card img{
      width:100%;
      height:auto;
      aspect-ratio: 4/3;
      object-fit: cover;
    }

    /* ▼ 改行表示のキャプション */
    .menu-card .cap{
      padding:.85rem .95rem;
      display:grid;
      gap:.28rem;
      align-items:start;
    }
    .menu-card .name{
      margin:0;
      color: rgba(255,255,255,.92);
      font-weight: 600;
      letter-spacing:.02em;
      line-height: 1.2;
    }
    .menu-card .note{
      margin:0;
      color: rgba(255,255,255,.62);
      font-size: .88rem;
      line-height: 1.35;
    }
    .menu-card .price{
      margin: .05rem 0 0;
      color: rgba(255,255,255,.85);
      font-size: .9rem;
      letter-spacing: .02em;
    }
    .yen{
      font-family: "Cinzel", serif;
      letter-spacing:.04em;
      margin-right: .35rem;
      opacity:.85;
    }

    /* 写真なし（下） */
    .menu-list{
      padding: 0 1rem 1.05rem;
      display:grid;
      gap: .45rem;
    }
    .menu-item{
      padding: .78rem .85rem;
      border-radius: .9rem;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      display:grid;
      gap:.28rem;
    }
    .menu-item .name{ color: rgba(255,255,255,.90); font-weight: 600; letter-spacing:.01em; line-height: 1.2; }
    .menu-item .note{ color: rgba(255,255,255,.60); font-size: .86rem; line-height: 1.35; }
    .menu-item .price{ color: rgba(255,255,255,.85); font-size: .9rem; margin-top:.05rem; }

    .statusline{
      margin-top: .6rem;
      color: rgba(255,255,255,.55);
      font-size: .85rem;
    }
    .error{
      margin-top: 1rem;
      padding: 1rem;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.85);
    }

    @media (min-width: 48rem){
      .menu-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>

<body>
  <header class="sticky-header" aria-label="ページナビゲーション">
    <a class="sticky-brand" href="index.html#drinks" aria-label="トップへ戻る">
      <img src="assets/img/logo.png" alt="" aria-hidden="true">
      <span>WACK DA. VINCI</span>
    </a>

    <nav class="sticky-nav" aria-label="ページ操作">
      <a href="index.html#drinks">Top</a>
      <a href="#menu">Menu</a>
      <a href="index.html#info">Access</a>
    </nav>
  </header>

  <main class="page" id="menu">
    <header class="page-head">
      <h1 class="page-title">Drinks Menu</h1>
    </header>

    <!-- ✅ 検索を削除。ジャンルチップのみ -->
    <div class="toolbar" aria-label="ジャンル絞り込み">
      <div class="chipbar" id="chipbar" aria-label="ジャンル"></div>
    </div>

    <div class="statusline" id="statusline"></div>

    <section class="menu" id="menuRoot" aria-label="ドリンクメニュー一覧"></section>

    <div id="errorBox" class="error" hidden></div>

    <div style="display:flex; justify-content:center; margin-top:1.6rem;">
      <a class="btn" href="index.html#drinks">トップに戻る</a>
    </div>
  </main>

  <script>
    // ===== 設定 =====
    const DATA_URL = "data/menu.json";

    const $ = (s, r=document) => r.querySelector(s);
    const el = (tag, cls) => { const n=document.createElement(tag); if(cls) n.className=cls; return n; };

    const menuRoot = $("#menuRoot");
    const chipbar = $("#chipbar");
    const statusline = $("#statusline");
    const errorBox = $("#errorBox");

    let rawData = null;
    let activeGenre = "all";

    function setError(msg){
      errorBox.hidden = false;
      errorBox.textContent = msg;
    }

    function formatPrice(p){
      if(p === null || p === undefined || p === "") return "";
      const n = Number(p);
      if(Number.isFinite(n)) return n.toLocaleString("ja-JP");
      return String(p);
    }

    function buildChips(genres){
      chipbar.innerHTML = "";

      const makeChip = (id, label) => {
        const b = el("button", "chip");
        b.type = "button";
        b.textContent = label;
        b.setAttribute("data-genre", id);
        b.setAttribute("aria-pressed", id === activeGenre ? "true" : "false");
        b.addEventListener("click", () => {
          activeGenre = id;
          [...chipbar.querySelectorAll(".chip")]
            .forEach(x => x.setAttribute("aria-pressed", x.dataset.genre === id ? "true" : "false"));
          render();
        });
        return b;
      };

      chipbar.appendChild(makeChip("all", "すべて"));
      for(const g of genres){
        chipbar.appendChild(makeChip(g.id, g.name));
      }
    }

    function makeLines(it, forCard){
      const wrap = el("div", forCard ? "cap" : "");
      const name = el("p", "name"); name.textContent = it.name || "";

      const noteText = (it.note || "").trim();
      const priceText = formatPrice(it.price);

      if(forCard){
        wrap.appendChild(name);

        if(noteText){
          const note = el("p", "note");
          note.textContent = noteText;
          wrap.appendChild(note);
        }
        if(priceText){
          const price = el("p", "price");
          price.innerHTML = `<span class="yen">¥</span>${priceText}`;
          wrap.appendChild(price);
        }
        return wrap;
      }else{
        // list row (grid) 用：中身は親に直接 append でもよいけど統一
        const frag = document.createDocumentFragment();
        frag.appendChild(name);

        if(noteText){
          const note = el("div", "note");
          note.textContent = noteText;
          frag.appendChild(note);
        }
        if(priceText){
          const price = el("div", "price");
          price.innerHTML = `<span class="yen">¥</span>${priceText}`;
          frag.appendChild(price);
        }
        return frag;
      }
    }

    function render(){
      if(!rawData) return;

      const genres = rawData.genres || [];
      menuRoot.innerHTML = "";

      let shownItems = 0;

      const filteredGenres = genres.filter(g => activeGenre === "all" ? true : g.id === activeGenre);

      for(const genre of filteredGenres){
        const items = Array.isArray(genre.items) ? genre.items : [];
        if(items.length === 0) continue;

        // 写真ありを先に
        const withImg = items.filter(it => it.img);
        const noImg   = items.filter(it => !it.img);

        shownItems += items.length;

        const article = el("article", "genre");

        const head = el("div", "genre-head");
        const h2 = document.createElement("h2");
        h2.textContent = genre.name || "Genre";
        const sub = document.createElement("span");
        sub.textContent = genre.subtitle || "";
        head.appendChild(h2);
        head.appendChild(sub);
        article.appendChild(head);

        if(withImg.length){
          const grid = el("div", "menu-grid");
          for(const it of withImg){
            const card = el("div", "menu-card");

            const img = document.createElement("img");
            img.src = it.img;
            img.alt = it.name || "";
            img.loading = "lazy";
            card.appendChild(img);

            // ✅ name / note / price を改行表示
            card.appendChild(makeLines(it, true));

            grid.appendChild(card);
          }
          article.appendChild(grid);
        }

        if(noImg.length){
          const list = el("div", "menu-list");
          for(const it of noImg){
            const row = el("div", "menu-item");
            // ✅ name / note / price を改行表示
            row.appendChild(makeLines(it, false));
            list.appendChild(row);
          }
          article.appendChild(list);
        }

        menuRoot.appendChild(article);
      }

      const updated = rawData.meta?.updated_at ? ` / 更新: ${rawData.meta.updated_at}` : "";
      const genreLabel = activeGenre === "all"
        ? "すべて"
        : (rawData.genres.find(g => g.id === activeGenre)?.name || activeGenre);

      statusline.textContent = `表示: ${shownItems}件 / ジャンル: ${genreLabel}${updated}`;
    }

    async function init(){
      try{
        const res = await fetch(DATA_URL, { cache: "no-store" });
        if(!res.ok) throw new Error(`menu.json を取得できませんでした（${res.status}）`);
        rawData = await res.json();

        buildChips(rawData.genres || []);
        render();
      }catch(e){
        setError(
          "メニューの読み込みに失敗しました。\n" +
          "・ローカル直開き(file://)だと失敗することがあります（Live Server推奨）\n" +
          "・data/menu.json のパスを確認してください\n\n" +
          String(e.message || e)
        );
      }
    }

    init();
  </script>
</body>
</html>
